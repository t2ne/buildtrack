@model BuildTrackMVC.Models.Obra

@{
    ViewData["Title"] = "Detalhes da Obra";
}

<style>
    /* Dark theme styles */
    .card {
        background-color: #2a2a2a;
        border: 1px solid #444;
    }

    .card-header {
        background-color: #2a2a2a;
        border-bottom: 1px solid #444;
        color: #fff;
    }

    .card-body {
        background-color: #2a2a2a;
        color: #fff;
    }

    .card-outline {
        border-top: 3px solid #ff9800;
    }

    /* Info boxes */
    .info-box {
        background-color: rgba(255, 152, 0, 0.1);
        border: 1px solid rgba(255, 152, 0, 0.3);
        color: #fff;
        min-height: 120px;
    }

    .info-box .info-box-icon {
        background-color: #ff9800;
        color: #fff;
        width: 120px;
        height: 120px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 3rem;
    }

    .info-box .info-box-content {
        color: #fff;
    }

    .info-box .info-box-text {
        color: #aaa;
        font-size: 0.9rem;
    }

    .info-box .info-box-number {
        color: #fff;
        font-weight: 600;
        font-size: 1.1rem;
    }

    .info-box .progress-description {
        color: #999;
        font-size: 0.85rem;
    }

    /* Tabs */
    .nav-pills .nav-link {
        color: #aaa;
        background-color: transparent;
        border-radius: 4px;
        transition: all 0.3s ease;
    }

    .nav-pills .nav-link:hover {
        background-color: rgba(255, 152, 0, 0.1);
        color: #ff9800;
    }

    .nav-pills .nav-link.active {
        background-color: #ff9800;
        color: #fff;
    }

    .nav-pills .nav-link i {
        margin-right: 0.5rem;
    }

    /* Tab content */
    .tab-content {
        padding-top: 1rem;
    }

    .tab-pane {
        animation: fadeIn 0.3s;
    }

    @@keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Alerts */
    .alert-info {
        background-color: rgba(30, 144, 255, 0.1);
        border: 1px solid rgba(30, 144, 255, 0.3);
        color: #9ecfff;
    }

    .alert-info .icon {
        color: #1e90ff;
    }

    /* Description lists */
    dl.row {
        margin-bottom: 0;
    }

    dl.row dt {
        color: #aaa;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    dl.row dt i {
        color: #ff9800;
        width: 20px;
        text-align: center;
    }

    dl.row dd {
        color: #fff;
        margin-bottom: 1rem;
    }

    /* Badges */
    .badge {
        font-size: 0.875rem;
        padding: 0.4rem 0.8rem;
    }

    .badge.bg-success {
        background-color: #28a745 !important;
    }

    .badge.bg-secondary {
        background-color: #6c757d !important;
    }

    /* Buttons */
    .btn-obras {
        background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
        border: none;
        color: white;
        font-weight: 500;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .btn-obras:hover {
        background: linear-gradient(135deg, #f57c00 0%, #e65100 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(255, 152, 0, 0.3);
        color: white;
    }

    .btn-danger {
        background-color: #dc3545;
        border-color: #dc3545;
        transition: all 0.3s ease;
    }

    .btn-danger:hover {
        background-color: #c82333;
        border-color: #bd2130;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
    }

    .btn-secondary {
        background-color: #444;
        border: 1px solid #666;
        color: #ddd;
        transition: all 0.3s ease;
    }

    .btn-secondary:hover {
        background-color: #555;
        border-color: #777;
        color: #fff;
        transform: translateY(-2px);
    }

    /* Breadcrumb */
    .breadcrumb {
        background-color: transparent;
        margin-bottom: 0;
    }

    .breadcrumb-item a {
        color: #ff9800;
        text-decoration: none;
    }

    .breadcrumb-item a:hover {
        color: #f57c00;
        text-decoration: underline;
    }

    .breadcrumb-item.active {
        color: #aaa;
    }

    .breadcrumb-item+.breadcrumb-item::before {
        color: #666;
    }

    /* Text utilities */
    .text-muted {
        color: #999 !important;
    }
</style>

<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0">
                    <i class="fas fa-hard-hat" style="color: #ff9800;"></i> @Model.Nome
                    @if (Model.Ativa)
                    {
                        <span class="badge bg-success ms-2">Ativa</span>
                    }
                    else
                    {
                        <span class="badge bg-secondary ms-2">Inativa</span>
                    }
                </h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-end">
                    <li class="breadcrumb-item"><a asp-action="Index">Obras</a></li>
                    <li class="breadcrumb-item active">Detalhes</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<section class="content">
    <div class="container-fluid">
        <div class="row mb-3">
            <div class="col-md-12">
                <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-obras">
                    <i class="fas fa-edit me-1"></i> Editar Obra
                </a>
                <a asp-action="Delete" asp-route-id="@Model.Id" class="btn btn-danger">
                    <i class="fas fa-trash-alt me-1"></i> Eliminar
                </a>
                <a asp-action="Index" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-1"></i> Voltar à Lista
                </a>
            </div>
        </div>

        <div class="card card-outline">
            <div class="card-header p-2">
                <ul class="nav nav-pills">
                    <li class="nav-item">
                        <a class="nav-link active" data-bs-toggle="tab" href="#tab_1">
                            <i class="fas fa-info-circle"></i> Dados Gerais
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#tab_2">
                            <i class="fas fa-boxes"></i> Registo de Material
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#tab_3">
                            <i class="fas fa-users-cog"></i> Mão de Obra
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#tab_4">
                            <i class="fas fa-euro-sign"></i> Pagamentos
                        </a>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <div class="tab-content">
                    <!-- Tab 1: Dados Gerais -->
                    <div class="tab-pane fade show active" id="tab_1">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="info-box">
                                    <span class="info-box-icon">
                                        <i class="fas fa-hard-hat"></i>
                                    </span>
                                    <div class="info-box-content">
                                        <span class="info-box-text">Nome da Obra</span>
                                        <span class="info-box-number">@Model.Nome</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="info-box"
                                    style="background-color: rgba(30, 144, 255, 0.1); border-color: rgba(30, 144, 255, 0.3);">
                                    <span class="info-box-icon" style="background-color: #1e90ff;">
                                        <i class="fas fa-user"></i>
                                    </span>
                                    <div class="info-box-content">
                                        <span class="info-box-text">Cliente</span>
                                        <span class="info-box-number">@Model.Cliente?.Nome</span>
                                        @if (!string.IsNullOrEmpty(Model.Cliente?.NIF))
                                        {
                                            <span class="progress-description">NIF: @Model.Cliente.NIF</span>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card mt-3">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <i class="fas fa-info-circle"></i> Informações Detalhadas
                                </h3>
                            </div>
                            <div class="card-body">
                                <dl class="row">
                                    @if (!string.IsNullOrEmpty(Model.Descricao))
                                    {
                                        <dt class="col-sm-3">
                                            <i class="fas fa-file-alt"></i> Descrição
                                        </dt>
                                        <dd class="col-sm-9">@Model.Descricao</dd>
                                    }

                                    <dt class="col-sm-3">
                                        <i class="fas fa-map-marker-alt"></i> Morada
                                    </dt>
                                    <dd class="col-sm-9">@Model.Morada</dd>

                                    @if (Model.Latitude.HasValue && Model.Longitude.HasValue)
                                    {
                                        <dt class="col-sm-3">
                                            <i class="fas fa-location-arrow"></i> Coordenadas GPS
                                        </dt>
                                        <dd class="col-sm-9">
                                            <strong>Latitude:</strong> @Model.Latitude?.ToString("F6")<br />
                                            <strong>Longitude:</strong> @Model.Longitude?.ToString("F6")
                                        </dd>
                                    }

                                    <dt class="col-sm-3">
                                        <i class="fas fa-toggle-on"></i> Estado
                                    </dt>
                                    <dd class="col-sm-9">
                                        @if (Model.Ativa)
                                        {
                                            <span class="badge bg-success">
                                                <i class="fas fa-check-circle me-1"></i> Obra Ativa
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary">
                                                <i class="fas fa-pause-circle me-1"></i> Obra Inativa
                                            </span>
                                        }
                                    </dd>
                                </dl>
                            </div>
                        </div>
                    </div>

                    <!-- Tab 2: Registo de Material -->
                    <div class="tab-pane fade" id="tab_2">
                        <div class="alert alert-info">
                            <h5><i class="icon fas fa-info"></i> Registo de Material</h5>
                            Aqui pode adicionar ou remover materiais da obra. Os movimentos afetam o stock global.
                        </div>
                        <partial name="Partials/_RegistoMateriais" model="@Model" />
                    </div>

                    <!-- Tab 3: Mão de Obra -->
                    <div class="tab-pane fade" id="tab_3">
                        <div class="alert alert-info">
                            <h5><i class="icon fas fa-info"></i> Registos de Mão de Obra</h5>
                            Registos de trabalho realizado nesta obra.
                        </div>
                        <partial name="Partials/_RegistoMaoObra" model="@Model" />
                    </div>

                    <!-- Tab 4: Pagamentos -->
                    <div class="tab-pane fade" id="tab_4">
                        <div class="alert alert-info">
                            <h5><i class="icon fas fa-info"></i> Registos de Pagamentos</h5>
                            Histórico de pagamentos efetuados relacionados com esta obra.
                        </div>
                        <partial name="Partials/_RegistoPagamentos" model="@Model" />
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <script>
        $(document).ready(function () {
            var obraId = @Model.Id;

            // Tab navigation
            var hash = window.location.hash;
            if (hash) {
                var tab = new bootstrap.Tab(document.querySelector('.nav-pills a[href="' + hash + '"]'));
                if (tab) {
                    tab.show();
                }
            }

            $('.nav-pills a[data-bs-toggle="tab"]').on('shown.bs.tab', function (e) {
                window.location.hash = e.target.getAttribute('href');
            });

            // ===== MATERIAIS =====
            loadMovimentos();

            $('#addMaterialForm').on('submit', function (e) {
                e.preventDefault();
                addMaterial();
            });

            function loadMovimentos() {
                $.ajax({
                    url: '/Movimentos/GetMovimentosByObra',
                    method: 'GET',
                    data: { obraId: obraId },
                    success: function (movimentos) {
                        var tbody = $('#materiaisTableBody');
                        tbody.empty();

                        if (movimentos.length === 0) {
                            tbody.html(
                                '<tr><td colspan="5" class="text-center py-4">' +
                                '<i class="fas fa-boxes fa-3x mb-3" style="color: #666; opacity: 0.3;"></i>' +
                                '<p style="color: #aaa; margin: 0;">Nenhum material registado nesta obra.</p>' +
                                '</td></tr>'
                            );
                        } else {
                            $.each(movimentos, function (index, mov) {
                                var operacaoBadge = mov.operacao === 'ADD' ?
                                    '<span class="badge bg-success"><i class="fas fa-plus me-1"></i>Entrada</span>' :
                                    '<span class="badge bg-danger"><i class="fas fa-minus me-1"></i>Saída</span>';

                                tbody.append(
                                    '<tr>' +
                                    '<td>' + mov.id + '</td>' +
                                    '<td>' + mov.materialNome + '</td>' +
                                    '<td>' + mov.quantidade + '</td>' +
                                    '<td>' + operacaoBadge + '</td>' +
                                    '<td>' + mov.dataHora + '</td>' +
                                    '</tr>'
                                );
                            });
                        }
                    }
                });
            }

            function addMaterial() {
                var formData = {
                    ObraId: obraId,
                    MaterialId: parseInt($('select[name="MaterialId"]').val()),
                    Quantidade: parseFloat($('input[name="Quantidade"]').val()),
                    Operacao: $('select[name="TipoOperacao"]').val()
                };

                $.ajax({
                    url: '/Movimentos/AddMovimento',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(formData),
                    success: function (response) {
                        if (response.success) {
                            $('#addMaterialForm')[0].reset();
                            loadMovimentos();
                        } else if (response.message) {
                            alert(response.message);
                        }
                    },
                    error: function (xhr) {
                        var response = xhr.responseJSON;
                        if (response && response.message) {
                            alert(response.message);
                        }
                    }
                });
            }

            // ===== MÃO DE OBRA =====
            loadRegistos();

            $('#addMaoObraForm').on('submit', function (e) {
                e.preventDefault();
                addRegisto();
            });

            function loadRegistos() {
                $.ajax({
                    url: '/RegistosMaoObra/GetRegistosByObra',
                    method: 'GET',
                    data: { obraId: obraId },
                    success: function (registos) {
                        var tbody = $('#maoObraTableBody');
                        tbody.empty();

                        if (registos.length === 0) {
                            tbody.html(
                                '<tr><td colspan="7" class="text-center py-4">' +
                                '<i class="fas fa-users-cog fa-3x mb-3" style="color: #666; opacity: 0.3;"></i>' +
                                '<p style="color: #aaa; margin: 0;">Nenhum registo de mão de obra nesta obra.</p>' +
                                '</td></tr>'
                            );
                        } else {
                            $.each(registos, function (index, reg) {
                                tbody.append(
                                    '<tr>' +
                                    '<td>' + reg.id + '</td>' +
                                    '<td>' + reg.nomeTrabalhador + '</td>' +
                                    '<td>' + reg.horasTrabalhadas + 'h</td>' +
                                    '<td>€ ' + reg.valorHora.toFixed(2) + '</td>' +
                                    '<td><strong>€ ' + reg.total.toFixed(2) + '</strong></td>' +
                                    '<td>' + reg.dataRegisto + '</td>' +
                                    '<td>' + (reg.descricaoTrabalho || '-') + '</td>' +
                                    '</tr>'
                                );
                            });
                        }
                    }
                });
            }

            function addRegisto() {
                var formData = {
                    ObraId: obraId,
                    NomeTrabalhador: $('input[name="NomeTrabalhador"]').val(),
                    HorasTrabalhadas: parseFloat($('input[name="HorasTrabalhadas"]').val()),
                    ValorHora: parseFloat($('input[name="ValorHora"]').val()),
                    DataRegisto: $('input[name="DataRegisto"]').val(),
                    DescricaoTrabalho: $('textarea[name="DescricaoTrabalho"]').val()
                };

                console.log('Enviando registo:', formData);

                $.ajax({
                    url: '/RegistosMaoObra/AddRegisto',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(formData),
                    success: function (response) {
                        console.log('Resposta:', response);
                        if (response.success) {
                            $('#addMaoObraForm')[0].reset();
                            $('input[name="DataRegisto"]').val(new Date().toISOString().split('T')[0]);
                            loadRegistos();
                        } else if (response.message) {
                            alert('Erro: ' + response.message);
                        }
                    },
                    error: function (xhr) {
                        console.log('Erro:', xhr);
                        var response = xhr.responseJSON;
                        if (response && response.message) {
                            alert('Erro: ' + response.message);
                        } else {
                            alert('Erro ao guardar registo de mão de obra');
                        }
                    }
                });
            }

            // ===== PAGAMENTOS =====
            loadPagamentos();

            $('#addPagamentoForm').on('submit', function (e) {
                e.preventDefault();
                addPagamento();
            });

            function loadPagamentos() {
                $.ajax({
                    url: '/RegistosPagamentos/GetPagamentosByObra',
                    method: 'GET',
                    data: { obraId: obraId },
                    success: function (response) {
                        var tbody = $('#pagamentosTableBody');
                        tbody.empty();

                        if (response.pagamentos.length === 0) {
                            tbody.html(
                                '<tr><td colspan="6" class="text-center py-4">' +
                                '<i class="fas fa-wallet fa-3x mb-3" style="color: #666; opacity: 0.3;"></i>' +
                                '<p style="color: #aaa; margin: 0;">Nenhum pagamento registado nesta obra.</p>' +
                                '</td></tr>'
                            );
                            $('#totalPagamentos').text('€ 0,00');
                        } else {
                            $.each(response.pagamentos, function (index, pag) {
                                tbody.append(
                                    '<tr>' +
                                    '<td>' + pag.id + '</td>' +
                                    '<td>' + pag.tipoPagamento + '</td>' +
                                    '<td><strong>€ ' + pag.valor.toFixed(2) + '</strong></td>' +
                                    '<td>' + pag.dataPagamento + '</td>' +
                                    '<td>' + pag.metodoPagamento + '</td>' +
                                    '<td>' + (pag.descricao || '-') + '</td>' +
                                    '</tr>'
                                );
                            });
                            $('#totalPagamentos').text('€ ' + response.total.toFixed(2));
                        }
                    }
                });
            }

            function addPagamento() {
                var formData = {
                    ObraId: obraId,
                    TipoPagamento: $('select[name="TipoPagamento"]').val(),
                    Valor: parseFloat($('input[name="Valor"]').val()),
                    DataPagamento: $('input[name="DataPagamento"]').val(),
                    MetodoPagamento: $('select[name="MetodoPagamento"]').val(),
                    Descricao: $('textarea[name="Descricao"]').val()
                };

                $.ajax({
                    url: '/RegistosPagamentos/AddPagamento',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(formData),
                    success: function (response) {
                        if (response.success) {
                            $('#addPagamentoForm')[0].reset();
                            $('input[name="DataPagamento"]').val(new Date().toISOString().split('T')[0]);
                            loadPagamentos();
                        }
                    },
                    error: function () {
                        // Silent error handling
                    }
                });
            }
        });
    </script>
}